<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Wallet Token Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 28px;
        }

        .timestamp {
            color: #718096;
            font-size: 13px;
            margin-top: 8px;
            font-weight: 400;
        }

        .controls {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-group label {
            color: #4a5568;
            font-size: 14px;
            font-weight: 600;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            color: #2d3748;
            font-size: 24px;
            font-weight: 600;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            font-size: 22px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f7fafc;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
            border-bottom: 2px solid #e2e8f0;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #edf2f7;
        }

        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.3;
            font-size: 12px;
        }

        th.sort-asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
        }

        th.sort-desc::after {
            content: ' ‚ñº';
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f7fafc;
        }

        tbody tr.hidden {
            display: none;
        }

        td {
            padding: 15px 20px;
            color: #4a5568;
            font-size: 14px;
        }

        .wallet-name {
            font-weight: 600;
            color: #2d3748;
        }

        .token-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .token-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .token-details {
            display: flex;
            flex-direction: column;
        }

        .token-symbol {
            font-weight: 600;
            color: #2d3748;
        }

        .token-chain {
            font-size: 11px;
            color: #a0aec0;
            text-transform: uppercase;
        }

        .balance {
            font-weight: 600;
            color: #2d3748;
            text-align: right;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-input {
                min-width: 100%;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px;
            }
        }

        /* Password Protection Styles */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }

        .login-box h2 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .login-box p {
            color: #718096;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .password-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .password-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .app-content {
            display: none;
        }

        .app-content.unlocked {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Password Protection -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h2>üîê Zugriff gesch√ºtzt</h2>
            <p>Bitte Passwort eingeben, um fortzufahren</p>
            <div class="error-message" id="errorMessage">
                Falsches Passwort. Bitte versuche es erneut.
            </div>
            <input 
                type="password" 
                id="passwordInput" 
                class="password-input" 
                placeholder="Passwort eingeben..."
                onkeypress="if(event.key === 'Enter') checkPassword()"
            >
            <button class="login-btn" onclick="checkPassword()">Anmelden</button>
        </div>
    </div>

    <!-- Main App Content -->
    <div class="app-content" id="appContent">
    <div class="container">
        <div class="header">
            <h1>üîê Multi-Wallet Token Viewer</h1>
            <div class="timestamp">Version: 04.01.2026, 23:35:00 (Schweizer Zeit)</div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <label for="walletFilter">Wallet:</label>
                <input type="text" id="walletFilter" class="filter-input" placeholder="Wallet filtern...">
            </div>
            <div class="filter-group">
                <label for="tokenFilter">Token:</label>
                <input type="text" id="tokenFilter" class="filter-input" placeholder="Token filtern...">
            </div>
            <button class="btn btn-primary" onclick="loadAllWallets()">üîÑ Aktualisieren</button>
            <button class="btn btn-secondary" onclick="scanForMoreTokens()">üîç Weitere Token scannen</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Wallets</div>
                <div class="stat-value" id="walletCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Token gesamt</div>
                <div class="stat-value" id="tokenCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Chains</div>
                <div class="stat-value" id="chainCount">-</div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h2>üìä Token √úbersicht</h2>
            </div>
            <div id="tableContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Lade Wallet-Daten...</p>
                </div>
            </div>
        </div>
    </div>
    <!-- End Main App Content -->

    <script>
        // Fallback CDN wenn jsdelivr nicht funktioniert
        function loadWeb3Fallback() {
            console.log('‚ö†Ô∏è Haupt-CDN fehlgeschlagen, versuche Fallback...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/web3@latest/dist/web3.min.js';
            script.onerror = function() {
                console.log('‚ö†Ô∏è Fallback fehlgeschlagen, versuche GitHub CDN...');
                const script2 = document.createElement('script');
                script2.src = 'https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.10.0/dist/web3.min.js';
                document.head.appendChild(script2);
            };
            document.head.appendChild(script);
        }
    </script>

    <!-- Try multiple CDN sources for Web3 -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js" onerror="loadWeb3Fallback()"></script>
    <script>
        // ============================================
        // PASSWORD PROTECTION
        // ============================================
        // WICHTIG: √Ñndere das Passwort hier!
        const correctPasswordHash = 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855'; // Standard: "" (leer)
        
        // SHA-256 Hash Funktion
        async function hashPassword(password) {
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function checkPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const password = passwordInput.value;
            const errorMessage = document.getElementById('errorMessage');

            const hash = await hashPassword(password);

            if (hash === correctPasswordHash) {
                // Passwort korrekt
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContent').classList.add('unlocked');
                
                // Session speichern (optional)
                sessionStorage.setItem('authenticated', 'true');
                
                // Warte bis Web3 geladen ist, dann App starten
                initializeApp();
            } else {
                // Passwort falsch
                errorMessage.classList.add('show');
                passwordInput.value = '';
                passwordInput.focus();
                
                // Fehlermeldung nach 3 Sekunden ausblenden
                setTimeout(() => {
                    errorMessage.classList.remove('show');
                }, 3000);
            }
        }

        // Pr√ºfen ob bereits authentifiziert (Session)
        window.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('authenticated') === 'true') {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContent').classList.add('unlocked');
                initializeApp();
            } else {
                document.getElementById('passwordInput').focus();
            }
        });

        // ============================================
        // MAIN APPLICATION CODE
        // ============================================
        
        // Globale Variablen
        let web3Instances = {};
        let allBalances = [];
        let currentSort = { column: null, direction: 'asc' };

        // Wallet-Konfiguration
        const wallets = [
            { name: 'dao1 Dubai', address: '0xC7e112D6Db20A4A9213834B2Cb235c34733e6591' },
            { name: 'Dubai trustyfy', address: '0x59dc6669c1eb40df7b36be58812202a09c4491bf' },
            { name: 'Dubai Mt. Pelerin', address: '0x76882e6fc045391ba4f19d8a15ea4d8699ff7382' },
            { name: 'TLN Chris', address: '0xbE44d90daD6308AE0b762908D70260c62410346E' }
        ];

        // Token-Konfiguration
        const tokens = {
            apertum: [
                { symbol: 'APTM', name: 'Apertum', address: 'native', decimals: 18 },
                { symbol: 'wAPTM', name: 'Wrapped APTM', address: '0x110ac02ba3384bc055c13a87766049a74517beda', decimals: 18 },
                { symbol: 'wUSDT', name: 'Wrapped USDT', address: '0x1487db421f6b58e77bfefc905fdc1ede5fb85c7f', decimals: 6 },
                { symbol: 'wUSDC', name: 'Wrapped USDC', address: '0xd979f41e12a69aa82f04866444ea91e8e8faefd9', decimals: 6 },
                { symbol: 'wBTC', name: 'Wrapped BTC', address: '0x75598b9f54df1472bb2bdc3b5dc791bdb109a52b', decimals: 8 },
                { symbol: 'wSOL', name: 'Wrapped SOL', address: '0xf081daa36f367f4a5f93ac68c14fb39b50a58ef8', decimals: 9 },
                { symbol: 'wETH', name: 'Wrapped ETH', address: '0x01882c43aa0bee891b54857c15cc19a3df946f01', decimals: 18 },
                { symbol: 'wBNB', name: 'Wrapped BNB', address: '0xf3074054737b9e83d73c3c17a007939e12698d5c', decimals: 18 },
                { symbol: 'wAVAX', name: 'Wrapped AVAX', address: '0xf75dd43f59cba81329f2fa3d98d0c0908cffebb8', decimals: 18 }
            ],
            bsc: [
                { symbol: 'BNB', name: 'BNB', address: 'native', decimals: 18 },
                { symbol: 'USDT', name: 'Tether USD', address: '0x55d398326f99059ff775485246999027b3197955', decimals: 18 },
                { symbol: 'USDC', name: 'USD Coin', address: '0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d', decimals: 18 },
                { symbol: 'VOW/BTCB', name: 'VOW / BTCB LP', address: '0x6B27bB584F44f55E865432dCeb9eBBE9A17fd4A8', decimals: 18 },
                { symbol: 'BTCB', name: 'BTCB Token', address: '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c', decimals: 18 },
                { symbol: 'VOW', name: 'VOW Token', address: '0xF585B5b4f22816BAf7629AEA55B701662630397b', decimals: 18 },
                { symbol: 'TLN+', name: 'TLN+', address: '0x29280091Fa7F3ABe4739Ad5f1f7C5287feAf7736', decimals: 18 },
                { symbol: 'TLNx', name: 'TLNx', address: '0x3ddA9eA88136EceDe768CD374a2af37219da55e7', decimals: 18 },
                { symbol: 'v$', name: 'VOW Dollar USA (TLN 3)', address: '0x9C23942Ca2C35e06d1d20747F33705983A18d2AB', decimals: 18 },
                { symbol: 'CAKE-LP', name: 'Pancakeswap LP (TLN 3)', address: '0xC51C99af9D5c31D0C37d028500b2b344DEbDf188', decimals: 18 },
                { symbol: 'USDC', name: 'Binance Pegged USD Coin', address: '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d', decimals: 18 },
                { symbol: 'TLN', name: 'TLN Token (TLN 1+2)', address: '0xf7d142a354322C7560250CaA0e2a06c89649e4C2', decimals: 18 },
                { symbol: 'vUSD', name: 'vUSD Token (TLN 1+2)', address: '0xc0D8DaA6516BaB4eFCe440860987E735BaB44160', decimals: 18 },
                { symbol: 'CAKE-LP', name: 'Pancakeswap LP (TLN 1+2)', address: '0x72dCf845AE36401e82e681B0E063d0703bAC0Bba', decimals: 18 },
                { symbol: 'UNI-LP', name: 'Uniswap LPT (Vow/v$)', address: '0x30812DBE89b40b5B7aC1BC9134e82EbBc0b57995', decimals: 18 }
            ],
            eth: [
                { symbol: 'ETH', name: 'Ethereum', address: 'native', decimals: 18 },
                { symbol: 'USDT', name: 'Tether USD', address: '0xdac17f958d2ee523a2206206994597c13d831ec7', decimals: 6 },
                { symbol: 'USDC', name: 'USD Coin', address: '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', decimals: 6 },
                { symbol: 'VOW', name: 'Vow Token', address: '0x1BBf25e71EC48B84d773809B4bA55B6F4bE946Fb', decimals: 18 },
                { symbol: 'v$', name: 'VOW Dollar USA (TLN 3)', address: '0xBa7fE208E0167e4047a996e1Efea830515F433F8', decimals: 18 },
                { symbol: 'vUSD', name: 'vUSD Token (TLN 1+2)', address: '0x0fc6C0465C9739d4a42dAca22eB3b2CB0Eb9937A', decimals: 18 },
                { symbol: 'LP', name: 'LP (Vow/v$) Token', address: '0x97BE09f2523B39B835Da9EA3857CfA1D3C660cBb', decimals: 18 }
            ],
            polygon: [
                { symbol: 'POL', name: 'Polygon', address: 'native', decimals: 18 }
            ]
        };

        // RPC-Endpunkte
        const rpcEndpoints = {
            apertum: 'https://rpc.apertum.io/ext/bc/YDJ1r9RMkewATmA7B35q1bdV18aywzmdiXwd9zGBq3uQjsCnn/rpc',
            bsc: 'https://bsc-dataseed.binance.org/',
            eth: 'https://eth.llamarpc.com',
            polygon: 'https://polygon-rpc.com'
        };

        // Web3 initialisieren
        function initializeWeb3() {
            console.log('üîß Initialisiere Web3...');
            console.log('Pr√ºfe ob Web3 verf√ºgbar ist...');
            console.log('typeof Web3:', typeof Web3);
            
            // Pr√ºfen ob Web3 bereits geladen ist
            if (typeof Web3 !== 'undefined') {
                console.log('‚úì Web3 ist bereits geladen');
                createWeb3Instances();
                return Promise.resolve(true);
            }

            console.log('‚è≥ Warte auf Web3-Load...');

            // Warten auf Web3-Load
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100; // 10 Sekunden

                const checkWeb3 = setInterval(() => {
                    attempts++;
                    console.log(`Versuch ${attempts}/${maxAttempts} - Web3 Status:`, typeof Web3);

                    if (typeof Web3 !== 'undefined') {
                        console.log('‚úì Web3 erfolgreich geladen nach', attempts * 100, 'ms');
                        clearInterval(checkWeb3);
                        createWeb3Instances();
                        resolve(true);
                    }

                    if (attempts >= maxAttempts) {
                        clearInterval(checkWeb3);
                        console.error('‚ùå Web3 konnte nicht geladen werden nach', attempts * 100, 'ms');
                        console.error('M√∂gliche Ursachen:');
                        console.error('- CDN ist blockiert (Firewall, AdBlocker)');
                        console.error('- Keine Internetverbindung');
                        console.error('- Browser-Extension blockiert Script');
                        displayError('Web3-Bibliothek konnte nicht geladen werden. Bitte pr√ºfe deine Internetverbindung und Browser-Extensions (AdBlocker, etc.)');
                        resolve(false);
                    }
                }, 100);
            });
        }

        function createWeb3Instances() {
            web3Instances = {};
            for (const [chain, rpc] of Object.entries(rpcEndpoints)) {
                web3Instances[chain] = new Web3(rpc);
                console.log(`  ‚úì Web3 f√ºr ${chain} initialisiert`);
            }
        }

        // App initialisieren
        async function initializeApp() {
            const web3Ready = await initializeWeb3();
            if (web3Ready) {
                loadAllWallets();
            }
        }

        // ERC-20 ABI
        const ERC20_ABI = [
            {
                "constant": true,
                "inputs": [],
                "name": "name",
                "outputs": [{"name": "", "type": "string"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "symbol",
                "outputs": [{"name": "", "type": "string"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "decimals",
                "outputs": [{"name": "", "type": "uint8"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "_owner", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "balance", "type": "uint256"}],
                "type": "function"
            }
        ];

        async function loadAllWallets() {
            try {
                console.log('üöÄ Starte Laden der Wallets...');
                const content = document.getElementById('tableContent');
                content.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Lade Token-Daten von allen Chains...</p>
                        <p style="font-size: 12px; margin-top: 10px;" id="loadingStatus"></p>
                    </div>
                `;

                allBalances = [];
                let processed = 0;
                let total = 0;

                // Z√§hle total Abfragen
                for (const wallet of wallets) {
                    for (const [chain, tokenList] of Object.entries(tokens)) {
                        total += tokenList.length;
                    }
                }

                console.log(`üìä Total zu ladende Token: ${total}`);

                // F√ºr jedes Wallet alle Token auf allen Chains laden
                for (const wallet of wallets) {
                    console.log(`üëõ Lade Wallet: ${wallet.name}`);
                    
                    for (const [chain, tokenList] of Object.entries(tokens)) {
                        console.log(`‚õìÔ∏è Chain: ${chain}`);
                        const web3 = web3Instances[chain];
                        
                        for (const token of tokenList) {
                            try {
                                processed++;
                                const statusEl = document.getElementById('loadingStatus');
                                if (statusEl) {
                                    statusEl.textContent = `${processed} von ${total} Token geladen...`;
                                }

                                let balance;
                                
                                if (token.address === 'native') {
                                    // Native Token (ETH, BNB, etc.)
                                    console.log(`  ü™ô Lade Native Token: ${token.symbol}`);
                                    const weiBalance = await web3.eth.getBalance(wallet.address);
                                    balance = parseFloat(web3.utils.fromWei(weiBalance, 'ether'));
                                } else {
                                    // ERC-20 Token
                                    console.log(`  ü™ô Lade ERC-20 Token: ${token.address}`);
                                    const contract = new web3.eth.Contract(ERC20_ABI, token.address);
                                    
                                    // WICHTIG: Decimals IMMER vom Contract abrufen
                                    let actualDecimals = token.decimals; // Fallback
                                    try {
                                        actualDecimals = await contract.methods.decimals().call();
                                        actualDecimals = parseInt(actualDecimals);
                                        console.log(`    üìä Decimals vom Contract: ${actualDecimals}`);
                                    } catch (decimalsError) {
                                        console.log(`    ‚ö†Ô∏è Konnte Decimals nicht abrufen, √ºberspringe Token`);
                                        continue; // Token √ºberspringen wenn nicht valide
                                    }
                                    
                                    // Balance abrufen
                                    let rawBalance;
                                    try {
                                        rawBalance = await contract.methods.balanceOf(wallet.address).call();
                                    } catch (balanceError) {
                                        console.log(`    ‚ö†Ô∏è Konnte Balance nicht abrufen, √ºberspringe Token`);
                                        continue; // Token √ºberspringen wenn Balance-Call fehlschl√§gt
                                    }
                                    
                                    // Token-Info abrufen (Name, Symbol)
                                    let tokenName = token.name;
                                    let tokenSymbol = token.symbol;
                                    
                                    try {
                                        const [fetchedName, fetchedSymbol] = await Promise.all([
                                            contract.methods.name().call().catch(() => token.name),
                                            contract.methods.symbol().call().catch(() => token.symbol)
                                        ]);
                                        
                                        tokenName = fetchedName;
                                        tokenSymbol = fetchedSymbol;
                                        
                                        console.log(`    ‚ÑπÔ∏è Token Info: ${tokenName} (${tokenSymbol}), Decimals: ${actualDecimals}`);
                                    } catch (infoError) {
                                        console.log(`    ‚ö†Ô∏è Konnte Token-Info nicht abrufen, verwende Adresse als Name`);
                                        tokenName = token.address.substring(0, 10) + '...';
                                        tokenSymbol = 'TOKEN';
                                    }
                                    
                                    // Balance mit den KORREKTEN Decimals berechnen
                                    balance = parseFloat(rawBalance) / Math.pow(10, actualDecimals);
                                    
                                    // Token-Info f√ºr die Anzeige updaten
                                    token.name = tokenName;
                                    token.symbol = tokenSymbol;
                                    token.decimals = actualDecimals;
                                }

                                console.log(`    ‚úì Balance: ${balance} ${token.symbol}`);

                                if (balance > 0) {
                                    allBalances.push({
                                        wallet: wallet.name,
                                        walletAddress: wallet.address,
                                        tokenSymbol: token.symbol,
                                        tokenName: token.name,
                                        chain: chain,
                                        balance: balance,
                                        tokenAddress: token.address
                                    });
                                    console.log(`    ‚úÖ Token hinzugef√ºgt (Balance > 0)`);
                                }
                            } catch (error) {
                                console.log(`    ‚ö†Ô∏è Token √ºbersprungen wegen Fehler:`, error.message);
                                // Einfach weitermachen mit n√§chstem Token
                            }
                        }
                    }
                }

                console.log(`‚úÖ Laden abgeschlossen. ${allBalances.length} Token mit Balance gefunden.`);
                displayTable();
                updateStats();

            } catch (error) {
                console.error('üí• Kritischer Fehler beim Laden:', error);
                displayError('Fehler beim Laden der Wallet-Daten: ' + error.message);
            }
        }

        function displayTable() {
            const content = document.getElementById('tableContent');
            
            if (allBalances.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <p>Keine Token mit Balance gefunden.</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('wallet')">Wallet</th>
                            <th class="sortable" onclick="sortTable('tokenSymbol')">Token</th>
                            <th class="sortable" onclick="sortTable('balance')">Anzahl</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        ${generateTableRows()}
                    </tbody>
                </table>
            `;

            content.innerHTML = tableHTML;
        }

        function generateTableRows() {
            return allBalances.map((item, index) => `
                <tr data-index="${index}">
                    <td class="wallet-name">${item.wallet}</td>
                    <td>
                        <div class="token-info">
                            <div class="token-icon">${item.tokenSymbol.charAt(0)}</div>
                            <div class="token-details">
                                <div class="token-symbol">${item.tokenSymbol}</div>
                                <div class="token-chain">${item.chain}</div>
                            </div>
                        </div>
                    </td>
                    <td class="balance">${formatNumber(item.balance)}</td>
                </tr>
            `).join('');
        }

        function sortTable(column) {
            // Sortierrichtung bestimmen
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Sortieren
            allBalances.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (currentSort.direction === 'asc') {
                    return valA > valB ? 1 : -1;
                } else {
                    return valA < valB ? 1 : -1;
                }
            });

            // Tabelle neu rendern
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = generateTableRows();

            // Sort-Indicator aktualisieren
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const clickedHeader = Array.from(document.querySelectorAll('th')).find(th => 
                th.textContent.includes(column === 'wallet' ? 'Wallet' : 
                                       column === 'tokenSymbol' ? 'Token' : 'Anzahl')
            );
            
            if (clickedHeader) {
                clickedHeader.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            }

            // Filter neu anwenden
            applyFilters();
        }

        function applyFilters() {
            const walletFilter = document.getElementById('walletFilter').value.toLowerCase();
            const tokenFilter = document.getElementById('tokenFilter').value.toLowerCase();

            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach((row, index) => {
                const item = allBalances[index];
                const matchesWallet = item.wallet.toLowerCase().includes(walletFilter);
                const matchesToken = item.tokenSymbol.toLowerCase().includes(tokenFilter);

                if (matchesWallet && matchesToken) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
        }

        function updateStats() {
            document.getElementById('walletCount').textContent = wallets.length;
            document.getElementById('tokenCount').textContent = allBalances.length;
            document.getElementById('chainCount').textContent = Object.keys(tokens).length;
        }

        function displayError(message) {
            const content = document.getElementById('tableContent');
            content.innerHTML = `
                <div class="error">
                    <strong>‚ö†Ô∏è Fehler:</strong> ${message}
                </div>
            `;
        }

        function formatNumber(num) {
            // Schweizer Zahlenformat: ' als Tausenderzeichen, . als Dezimalzeichen
            
            // Bestimme Dezimalstellen basierend auf Gr√∂sse
            let decimals;
            if (num >= 1000) {
                decimals = 2; // Grosse Zahlen: 2 Dezimalstellen
            } else if (num >= 1) {
                decimals = 4; // Normale Zahlen: 4 Dezimalstellen
            } else if (num >= 0.01) {
                decimals = 6; // Kleine Zahlen: 6 Dezimalstellen
            } else {
                decimals = 8; // Sehr kleine Zahlen: 8 Dezimalstellen
            }
            
            // Zahl formatieren
            const fixedNum = num.toFixed(decimals);
            
            // In Ganzzahl und Dezimalteil aufteilen
            const parts = fixedNum.split('.');
            const integerPart = parts[0];
            const decimalPart = parts[1];
            
            // Tausendertrennzeichen (Apostroph) hinzuf√ºgen
            const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, "'");
            
            // Zusammensetzen mit Punkt als Dezimaltrennzeichen
            return decimalPart ? `${formattedInteger}.${decimalPart}` : formattedInteger;
        }

        function scanForMoreTokens() {
            alert('Token-Scan-Funktion wird implementiert. Diese Funktion durchsucht die Blockchain nach zus√§tzlichen Token, die noch nicht in der Liste sind.');
            // Hier k√∂nnte die Scan-Funktion aus der vorherigen Version eingef√ºgt werden
        }

        // Event Listener f√ºr Filter
        document.getElementById('walletFilter').addEventListener('input', applyFilters);
        document.getElementById('tokenFilter').addEventListener('input', applyFilters);
    </script>
</body>
</html>
